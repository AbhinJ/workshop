

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>4. Create a Network Topology &mdash; Workshop - FOSS4G routing with pgRouting</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Workshop - FOSS4G routing with pgRouting" href="../index.html" />
    <link rel="next" title="5. pgRouting Algorithms" href="shortest_path.html" />
    <link rel="prev" title="3. Installation and Requirements" href="installation.html" />
	<script type="text/javascript">
	/* <![CDATA[ */
	    (function() {
	        var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];
	        s.type = 'text/javascript';
	        s.async = true;
	        s.src = 'http://api.flattr.com/js/0.6/load.js?mode=auto';
	        t.parentNode.insertBefore(s, t);
	    })();
	/* ]]> */</script>

	<style>
		.toctree-wrapper {
			-webkit-column-count: 2;
			-moz-column-count: 2;
			column-count: 2;
		}
	</style>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="shortest_path.html" title="5. pgRouting Algorithms"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="installation.html" title="3. Installation and Requirements"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Workshop - FOSS4G routing with pgRouting</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="create-a-network-topology">
<span id="topology"></span><h1>4. Create a Network Topology<a class="headerlink" href="#create-a-network-topology" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="osm2pgrouting.html"><em>osm2pgrouting</em></a> is a convenient tool, but it&#8217;s also a <em>black box</em>. There are several cases where <a class="reference internal" href="osm2pgrouting.html"><em>osm2pgrouting</em></a> can&#8217;t be used. Obviously if the data isn&#8217;t OpenStreetMap data. Some network data already comes with a network topology that can be used with pgRouting out-of-the-box. Often network data is stored in Shape file format (<tt class="docutils literal"><span class="pre">.shp</span></tt>) and we can use PostGIS&#8217; <tt class="docutils literal"><span class="pre">shape2postgresql</span></tt> converter to import the data into a PostgreSQL database. But what to do then?</p>
<img alt="../_images/network.png" class="align-center" src="../_images/network.png" style="width: 250pt;" />
<p>In this chapter you will learn how to create a network topology from scratch. For that we will start with data that contains the minimum attributes needed for routing and show how to proceed step-by-step to build routable data for pgRouting.</p>
<div class="section" id="load-network-data">
<h2>4.1. Load network data<a class="headerlink" href="#load-network-data" title="Permalink to this headline">¶</a></h2>
<p>At first we will load a database dump from the workshop <tt class="docutils literal"><span class="pre">data</span></tt> directory. This directory contains a compressed file with database dumps as well as a small size network data. If you haven&#8217;t uncompressed the data yet, extract the file by</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">cd</span> ~/Desktop/pgrouting-workshop/
tar -xvzf data.tar.gz
</pre></div>
</div>
<p>The following command will import the database dump. It will add PostGIS and pgRouting functions to a database, in the same way as decribed in the previous chapter. It will also load the sample data with a minimum number of attributes, which you will usually find in any network data:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># Optional: Drop database</span>
dropdb -U user pgrouting-workshop

<span class="c"># Load database dump file</span>
psql -U user -d postgres -f ~/Desktop/pgrouting-workshop/data/sampledata_notopo.sql
</pre></div>
</div>
<p>Let&#8217;s see wich tables have been created:</p>
<p class="rubric">Run: <tt class="docutils literal"><span class="pre">psql</span> <span class="pre">-U</span> <span class="pre">user</span> <span class="pre">-d</span> <span class="pre">pgrouting-workshop</span> <span class="pre">-c</span> <span class="pre">&quot;\d&quot;</span></tt></p>
<div class="highlight-sql"><div class="highlight"><pre>               <span class="n">List</span> <span class="k">of</span> <span class="n">relations</span>
 <span class="k">Schema</span> <span class="o">|</span>       <span class="n">Name</span>        <span class="o">|</span> <span class="k">Type</span>  <span class="o">|</span>  <span class="k">Owner</span>
<span class="c1">--------+-------------------+-------+----------</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">geography_columns</span> <span class="o">|</span> <span class="k">view</span>  <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">geometry_columns</span>  <span class="o">|</span> <span class="k">view</span>  <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">raster_columns</span>    <span class="o">|</span> <span class="k">view</span>  <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">raster_overviews</span>  <span class="o">|</span> <span class="k">view</span>  <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">spatial_ref_sys</span>   <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">ways</span>              <span class="o">|</span> <span class="k">table</span> <span class="o">|</span> <span class="k">user</span>
<span class="p">(</span><span class="mi">7</span> <span class="k">rows</span><span class="p">)</span>
</pre></div>
</div>
<p>The table containing the road network data has the name <tt class="docutils literal"><span class="pre">ways</span></tt>. It consists of the following attributes:</p>
<p class="rubric">Run: <tt class="docutils literal"><span class="pre">psql</span> <span class="pre">-U</span> <span class="pre">user</span> <span class="pre">-d</span> <span class="pre">pgrouting-workshop</span> <span class="pre">-c</span> <span class="pre">&quot;\d</span> <span class="pre">ways&quot;</span></tt></p>
<div class="highlight-sql"><div class="highlight"><pre>               <span class="k">Table</span> <span class="ss">&quot;public.ways&quot;</span>
  <span class="k">Column</span>  <span class="o">|</span>           <span class="k">Type</span>            <span class="o">|</span> <span class="n">Modifiers</span>
<span class="c1">----------+---------------------------+-----------</span>
 <span class="n">gid</span>      <span class="o">|</span> <span class="nb">bigint</span>                    <span class="o">|</span>
 <span class="n">class_id</span> <span class="o">|</span> <span class="nb">integer</span>                   <span class="o">|</span> <span class="k">not</span> <span class="k">null</span>
 <span class="k">length</span>   <span class="o">|</span> <span class="n">double</span> <span class="k">precision</span>          <span class="o">|</span>
 <span class="n">name</span>     <span class="o">|</span> <span class="nb">character</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>            <span class="o">|</span>
 <span class="n">osm_id</span>   <span class="o">|</span> <span class="nb">bigint</span>                    <span class="o">|</span>
 <span class="n">the_geom</span> <span class="o">|</span> <span class="n">geometry</span><span class="p">(</span><span class="n">LineString</span><span class="p">,</span><span class="mi">4326</span><span class="p">)</span> <span class="o">|</span>
<span class="n">Indexes</span><span class="p">:</span>
    <span class="ss">&quot;ways_gid_idx&quot;</span> <span class="k">UNIQUE</span><span class="p">,</span> <span class="n">btree</span> <span class="p">(</span><span class="n">gid</span><span class="p">)</span>
    <span class="ss">&quot;geom_idx&quot;</span> <span class="n">gist</span> <span class="p">(</span><span class="n">the_geom</span><span class="p">)</span>
</pre></div>
</div>
<p>It is common that road network data provides at least the following information:</p>
<ul class="simple">
<li>Road link ID (gid)</li>
<li>Road class (class_id)</li>
<li>Road link length (length)</li>
<li>Road name (name)</li>
<li>Road geometry (the_geom)</li>
</ul>
<p>This allows to display the road network as a PostGIS layer in GIS software, for example in QGIS. Though it is not sufficient for routing, because it doesn&#8217;t contain network topology information.</p>
<p>For the next steps we need to start the PostgreSQL command line tool</p>
<div class="highlight-bash"><div class="highlight"><pre>psql -U user pgrouting-workshop
</pre></div>
</div>
<p>... or use PgAdmin III.</p>
</div>
<div class="section" id="calculate-topology">
<h2>4.2. Calculate topology<a class="headerlink" href="#calculate-topology" title="Permalink to this headline">¶</a></h2>
<p>Having your data imported into a PostgreSQL database usually requires one more step for pgRouting. You have to make sure that your data provides a correct network topology, which consists of information about source and target ID of each road link.</p>
<p>If your network data doesn&#8217;t have such network topology information already you need to run the <tt class="docutils literal"><span class="pre">pgr_createTopology</span></tt> function. This function assigns a <tt class="docutils literal"><span class="pre">source</span></tt> and a <tt class="docutils literal"><span class="pre">target</span></tt> ID to each link and it can &#8220;snap&#8221; nearby vertices within a certain tolerance.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="n">pgr_createTopology</span><span class="p">(</span><span class="s1">&#39;&lt;table&gt;&#39;</span><span class="p">,</span> <span class="nb">float</span> <span class="n">tolerance</span><span class="p">,</span> <span class="s1">&#39;&lt;geometry column&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;gid&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>First we have to add source and target column, then we run the <tt class="docutils literal"><span class="pre">pgr_createTopology</span></tt> function ... and wait. Depending on the network size this process may take from minutes to hours. It will also require enough memory (RAM or SWAP partition) to store temporary data.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- Add &quot;source&quot; and &quot;target&quot; column</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">ways</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="ss">&quot;source&quot;</span> <span class="nb">integer</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">ways</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="ss">&quot;target&quot;</span> <span class="nb">integer</span><span class="p">;</span>

<span class="c1">-- Run topology function</span>
<span class="k">SELECT</span> <span class="n">pgr_createTopology</span><span class="p">(</span><span class="s1">&#39;ways&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">00001</span><span class="p">,</span> <span class="s1">&#39;the_geom&#39;</span><span class="p">,</span> <span class="s1">&#39;gid&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Execute <tt class="docutils literal"><span class="pre">psql</span> <span class="pre">-U</span> <span class="pre">user</span> <span class="pre">-d</span> <span class="pre">pgrouting-workshop</span></tt> in your terminal to connect to the database and start the PostgreSQL shell. Leave the shell with <tt class="docutils literal"><span class="pre">\q</span></tt> command.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The dimension of the tolerance parameter depends on your data projection. Usually it&#8217;s either &#8220;degrees&#8221; or &#8220;meters&#8221;.</p>
</div>
</div>
<div class="section" id="add-indices">
<h2>4.3. Add indices<a class="headerlink" href="#add-indices" title="Permalink to this headline">¶</a></h2>
<p>Make sure that your network table has an index for <tt class="docutils literal"><span class="pre">source</span></tt> and <tt class="docutils literal"><span class="pre">target</span></tt> columns.</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">ways_source_idx</span> <span class="k">ON</span> <span class="n">ways</span><span class="p">(</span><span class="ss">&quot;source&quot;</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">ways_target_idx</span> <span class="k">ON</span> <span class="n">ways</span><span class="p">(</span><span class="ss">&quot;target&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>After these steps our routing database looks like this:</p>
<p class="rubric">Run: <tt class="docutils literal"><span class="pre">\d</span></tt></p>
<div class="highlight-sql"><div class="highlight"><pre>                 <span class="n">List</span> <span class="k">of</span> <span class="n">relations</span>
 <span class="k">Schema</span> <span class="o">|</span>           <span class="n">Name</span>           <span class="o">|</span>   <span class="k">Type</span>   <span class="o">|</span>  <span class="k">Owner</span>
<span class="c1">--------+--------------------------+----------+----------</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">geography_columns</span>        <span class="o">|</span> <span class="k">view</span>     <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">geometry_columns</span>         <span class="o">|</span> <span class="k">view</span>     <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">raster_columns</span>           <span class="o">|</span> <span class="k">view</span>     <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">raster_overviews</span>         <span class="o">|</span> <span class="k">view</span>     <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">spatial_ref_sys</span>          <span class="o">|</span> <span class="k">table</span>    <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">ways_vertices_pgr</span>        <span class="o">|</span> <span class="k">table</span>    <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">ways_vertices_pgr_id_seq</span> <span class="o">|</span> <span class="n">sequence</span> <span class="o">|</span> <span class="k">user</span>
 <span class="k">public</span> <span class="o">|</span> <span class="n">ways</span>                     <span class="o">|</span> <span class="k">table</span>    <span class="o">|</span> <span class="k">user</span>
<span class="p">(</span><span class="mi">9</span> <span class="k">rows</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">geography_columns</span></tt> should contain a record for each table with &#8220;geometry&#8221; attribute and its SRID.</li>
<li><tt class="docutils literal"><span class="pre">ways_vertices_pgr</span></tt> contains a list of all network nodes.</li>
</ul>
<p class="rubric">Run: <tt class="docutils literal"><span class="pre">\d</span> <span class="pre">ways</span></tt></p>
<div class="highlight-sql"><div class="highlight"><pre>               <span class="k">Table</span> <span class="ss">&quot;public.ways&quot;</span>
  <span class="k">Column</span>  <span class="o">|</span>           <span class="k">Type</span>            <span class="o">|</span> <span class="n">Modifiers</span>
<span class="c1">----------+---------------------------+-----------</span>
 <span class="n">gid</span>      <span class="o">|</span> <span class="nb">integer</span>                   <span class="o">|</span>
 <span class="n">class_id</span> <span class="o">|</span> <span class="nb">integer</span>                   <span class="o">|</span> <span class="k">not</span> <span class="k">null</span>
 <span class="k">length</span>   <span class="o">|</span> <span class="n">double</span> <span class="k">precision</span>          <span class="o">|</span>
 <span class="n">name</span>     <span class="o">|</span> <span class="nb">text</span>                      <span class="o">|</span>
 <span class="n">osm_id</span>   <span class="o">|</span> <span class="nb">bigint</span>                    <span class="o">|</span>
 <span class="n">the_geom</span> <span class="o">|</span> <span class="n">geometry</span><span class="p">(</span><span class="n">LineString</span><span class="p">,</span><span class="mi">4326</span><span class="p">)</span> <span class="o">|</span>
 <span class="k">source</span>   <span class="o">|</span> <span class="nb">integer</span>                   <span class="o">|</span>
 <span class="n">target</span>   <span class="o">|</span> <span class="nb">integer</span>                   <span class="o">|</span>
<span class="n">Indexes</span><span class="p">:</span>
    <span class="ss">&quot;ways_gid_idx&quot;</span> <span class="k">UNIQUE</span><span class="p">,</span> <span class="n">btree</span> <span class="p">(</span><span class="n">gid</span><span class="p">)</span>
    <span class="ss">&quot;geom_idx&quot;</span> <span class="n">gist</span> <span class="p">(</span><span class="n">the_geom</span><span class="p">)</span>
    <span class="ss">&quot;ways_source_idx&quot;</span> <span class="n">btree</span> <span class="p">(</span><span class="k">source</span><span class="p">)</span>
    <span class="ss">&quot;ways_target_idx&quot;</span> <span class="n">btree</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">source</span></tt> and <tt class="docutils literal"><span class="pre">target</span></tt> columns are now updated with node IDs.</li>
<li><tt class="docutils literal"><span class="pre">name</span></tt> may contain the street name or be empty.</li>
<li><tt class="docutils literal"><span class="pre">length</span></tt> is the road link length in kilometers.</li>
</ul>
<p>Now we are ready for our first routing query with <a class="reference internal" href="shortest_path.html"><em>Dijkstra algorithm</em></a>!</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/pgrouting.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4. Create a Network Topology</a><ul>
<li><a class="reference internal" href="#load-network-data">4.1. Load network data</a></li>
<li><a class="reference internal" href="#calculate-topology">4.2. Calculate topology</a></li>
<li><a class="reference internal" href="#add-indices">4.3. Add indices</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="installation.html"
                        title="previous chapter">3. Installation and Requirements</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="shortest_path.html"
                        title="next chapter">5. pgRouting Algorithms</a></p>
	
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
	<h3>License</h3>
	<p style="font-size: 90%; margin-top:2px;">This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-Share Alike 3.0 License</a>.</p>
	<p style="margin:0 0 10px 0;"><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a></p>

	<!-- <p>
		<a class="FlattrButton" style="display:none;" rev="flattr;button:compact;" href="http://workshop.pgrouting.org"></a>
		<noscript><a href="http://flattr.com/thing/977418/pgRouting-Workshop" target="_blank">
		<img src="http://api.flattr.com/button/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0" /></a></noscript>
	</p> -->

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="shortest_path.html" title="5. pgRouting Algorithms"
             >next</a></li>
        <li class="right" >
          <a href="installation.html" title="3. Installation and Requirements"
             >previous</a> |</li>
        <li><a href="../index.html">Workshop - FOSS4G routing with pgRouting</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010-2014 Daniel Kastl, Frédéric Junod.
      Last updated on Sep 06, 2014.
    </div>
  </body>
</html>