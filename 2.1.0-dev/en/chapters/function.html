<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8. Routing from A to B (function) &mdash; Workshop - FOSS4G 2016 Bonn - Routing with pgRouting</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinxcontrib-images/LightBox2/lightbox2/css/lightbox.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-3.3.6/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
    <script type="text/javascript" src="../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Workshop - FOSS4G 2016 Bonn - Routing with pgRouting" href="../index.html" />
    <link rel="next" title="9. WMS server with GeoServer" href="geoserver.html" />
    <link rel="prev" title="7. Writing a pl/pgsql Wrapper" href="wrapper.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/pgrouting.png"></span>
          Workshop FOSS4G Bonn</a>
        <span class="navbar-text navbar-version pull-left"><b>2016</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Chapters <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">2. About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="about.html#pgrouting">2.1. pgRouting</a></li>
<li class="toctree-l2"><a class="reference internal" href="about.html#osm2pgrouting">2.2. osm2pgrouting</a></li>
<li class="toctree-l2"><a class="reference internal" href="about.html#openstreetmap">2.3. OpenStreetMap</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">3. Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#osgeo-live-using-a-usb-stick-or-dvd">3.1. OSGeo Live using a USB stick or DVD</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#osgeo-live-on-a-virtualbox">3.2. OSGeo Live on a virtualBox</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="prepare_data.html">4. Prepare Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="prepare_data.html#prepare-the-database">4.1. Prepare the database</a></li>
<li class="toctree-l2"><a class="reference internal" href="prepare_data.html#get-the-workshop-data">4.2. Get the Workshop Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="prepare_data.html#run-osm2pgrouting">4.3. Run osm2pgrouting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="shortest_path.html">5. pgRouting Algorithms</a><ul>
<li class="toctree-l2"><a class="reference internal" href="shortest_path.html#pgr-dijkstra">5.1. pgr_dijkstra</a></li>
<li class="toctree-l2"><a class="reference internal" href="shortest_path.html#pgr-dijkstracost">5.2. pgr_dijkstraCost</a></li>
<li class="toctree-l2"><a class="reference internal" href="shortest_path.html#pgr-astar">5.3. pgr_astar</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">6. Advanced Routing Queries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#routing-for-vehicles">6.1. Routing for Vehicles</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#cost-manipulations">6.2. Cost Manipulations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="wrapper.html">7. Writing a pl/pgsql Wrapper</a><ul>
<li class="toctree-l2"><a class="reference internal" href="wrapper.html#one-route-geometry">7.1. One Route geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="wrapper.html#wrapping-with-views">7.2. Wrapping with views</a></li>
<li class="toctree-l2"><a class="reference internal" href="wrapper.html#wrapping-with-functions">7.3. Wrapping with functions</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">8. Routing from A to B (function)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#route-between-lat-lon-points-and-return-ordered-geometry-with-heading">8.1. Route between lat/lon points and return ordered geometry with heading</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="geoserver.html">9. WMS server with GeoServer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="geoserver.html#connect-to-the-administration-page">9.1. Connect to the administration page</a></li>
<li class="toctree-l2"><a class="reference internal" href="geoserver.html#create-the-layer">9.2. Create the layer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ol3_client.html">10. OpenLayers 3 Based Routing Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ol3_client.html#openlayers-3-introduction">10.1. OpenLayers 3 introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="ol3_client.html#creating-a-minimal-map">10.2. Creating a minimal map</a></li>
<li class="toctree-l2"><a class="reference internal" href="ol3_client.html#wms-get-parameters">10.3. WMS GET parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="ol3_client.html#select-start-and-destination">10.4. Select &#8220;start&#8221; and &#8220;destination&#8221;</a></li>
<li class="toctree-l2"><a class="reference internal" href="ol3_client.html#clear-the-results">10.5. Clear the results</a></li>
<li class="toctree-l2"><a class="reference internal" href="ol3_client.html#summary-full-example">10.6. Summary (full example)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="topology.html">11. Create a Network Topology</a><ul>
<li class="toctree-l2"><a class="reference internal" href="topology.html#load-network-data">11.1. Load network data</a></li>
<li class="toctree-l2"><a class="reference internal" href="topology.html#create-a-routing-network-topology">11.2. Create a Routing Network Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="topology.html#verify-the-routing-network-topology">11.3. Verify the Routing Network Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="topology.html#analize-and-adjust-the-routing-network-topology">11.4. Analize and Adjust the Routing Network Topology</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="the_solutions.html">12. Appendix: Workshop Solutions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="the_solutions.html#dijkstra-solutions">12.1. <tt class="docutils literal"><span class="pre">dijkstra</span></tt> Solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="the_solutions.html#advanced-solutions">12.2. <tt class="docutils literal"><span class="pre">advanced</span></tt> Solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="the_solutions.html#wrapper-solutions">12.3. <tt class="docutils literal"><span class="pre">wrapper</span></tt> Solutions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="additional_installation.html">13. Appendix: Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="additional_installation.html#pgrouting">13.1. pgRouting</a></li>
<li class="toctree-l2"><a class="reference internal" href="additional_installation.html#pgrouting-workshop">13.2. pgRouting Workshop</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="osm2pgrouting.html">14. Appendix: osm2pgrouting Import Tool</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">8. Routing from A to B (function)</a><ul>
<li><a class="reference internal" href="#route-between-lat-lon-points-and-return-ordered-geometry-with-heading">8.1. Route between lat/lon points and return ordered geometry with heading</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="wrapper.html" title="Previous Chapter: 7. Writing a pl/pgsql Wrapper"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 7. Writing a pl/...</span>
    </a>
  </li>
  <li>
    <a href="geoserver.html" title="Next Chapter: 9. WMS server with GeoServer"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">9. WMS server wi... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="routing-from-a-to-b-function">
<span id="fromatob"></span><h1>8. Routing from A to B (function)<a class="headerlink" href="#routing-from-a-to-b-function" title="Permalink to this headline">¶</a></h1>
<p>The following function simplifies (and sets default values) when it calls the
shortest path Dijkstra function.</p>
<p class="rubric">Dijkstra Wrapper</p>
<div class="highlight-sql"><div class="highlight"><pre>--DROP FUNCTION my_dijkstra(varchar,int,int);

CREATE OR REPLACE FUNCTION my_dijkstra(
                IN tbl varchar,
                IN source integer,
                IN target integer,
                OUT seq integer,
                OUT gid integer,
                OUT geom geometry
        )
        RETURNS SETOF record AS
$BODY$
DECLARE
        sql text;
        rec record;
BEGIN
        seq := 0;
        sql := &#39;SELECT gid,the_geom FROM &#39; ||
                        &#39;pgr_dijkstra(&#39;&#39;SELECT gid as id, source::int, target::int, &#39;
                                        || &#39;length::float AS cost FROM &#39;
                                        || quote_ident(tbl) || &#39;&#39;&#39;, &#39;
                                        || quote_literal(source) || &#39;, &#39;
                                        || quote_literal(target) || &#39; , false, false), &#39;
                                || quote_ident(tbl) || &#39; WHERE id2 = gid ORDER BY seq&#39;;

        FOR rec IN EXECUTE sql
        LOOP
                seq  := seq + 1;
                gid  := rec.gid;
                geom := rec.the_geom;
                RETURN NEXT;
        END LOOP;
        RETURN;
END;
$BODY$
LANGUAGE &#39;plpgsql&#39;;
</pre></div>
</div>
<p class="rubric">Example query</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">my_dijkstra</span><span class="p">(</span><span class="s1">&#39;ways&#39;</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="route-between-lat-lon-points-and-return-ordered-geometry-with-heading">
<h2>8.1. Route between lat/lon points and return ordered geometry with heading<a class="headerlink" href="#route-between-lat-lon-points-and-return-ordered-geometry-with-heading" title="Permalink to this headline">¶</a></h2>
<p>The following function takes lat/lon points as input parameters and returns a
route that can be displayed in QGIS or WMS services such as Mapserver and
Geoserver:</p>
<p class="rubric">Input parameters</p>
<ul class="simple">
<li>Table name</li>
<li><tt class="docutils literal"><span class="pre">x1</span></tt>, <tt class="docutils literal"><span class="pre">y1</span></tt> for start point and <tt class="docutils literal"><span class="pre">x2</span></tt>, <tt class="docutils literal"><span class="pre">y2</span></tt> for end point</li>
</ul>
<p class="rubric">Output columns</p>
<ul class="simple">
<li>Sequence (for example to order the results afterwards)</li>
<li>Gid (for example to link the result back to the original table)</li>
<li>Street name</li>
<li>Heading in degree (simplified as it calculates the Azimuth between start and
end node of a link)</li>
<li>Costs as length in kilometer</li>
<li>The road link geometry</li>
</ul>
<p>What the function does internally:</p>
<ol class="arabic simple">
<li>Finds the nearest nodes to start and end point coordinates</li>
<li>Runs shortest path Dijkstra query</li>
<li>Flips the geometry if necessary, that target node of the previous road link
is the source of the following road link</li>
<li>Calculates the azimuth from start to end node of each road link</li>
<li>Returns the result as a set of records</li>
</ol>
<div class="highlight-sql"><div class="highlight"><pre>--
--DROP FUNCTION pgr_fromAtoB(varchar, double precision, double precision,
--                           double precision, double precision);

CREATE OR REPLACE FUNCTION pgr_fromAtoB(
                IN tbl varchar,
                IN x1 double precision,
                IN y1 double precision,
                IN x2 double precision,
                IN y2 double precision,
                OUT seq integer,
                OUT gid integer,
                OUT name text,
                OUT heading double precision,
                OUT cost double precision,
                OUT geom geometry
        )
        RETURNS SETOF record AS
$BODY$
DECLARE
        sql     text;
        rec     record;
        source	integer;
        target	integer;
        point	integer;

BEGIN
	-- Find nearest node
	EXECUTE &#39;SELECT id::integer FROM ways_vertices_pgr
			ORDER BY the_geom &lt;-&gt; ST_GeometryFromText(&#39;&#39;POINT(&#39;
			|| x1 || &#39; &#39; || y1 || &#39;)&#39;&#39;,4326) LIMIT 1&#39; INTO rec;
	source := rec.id;

	EXECUTE &#39;SELECT id::integer FROM ways_vertices_pgr
			ORDER BY the_geom &lt;-&gt; ST_GeometryFromText(&#39;&#39;POINT(&#39;
			|| x2 || &#39; &#39; || y2 || &#39;)&#39;&#39;,4326) LIMIT 1&#39; INTO rec;
	target := rec.id;

	-- Shortest path query (TODO: limit extent by BBOX)
        seq := 0;
        sql := &#39;SELECT gid, the_geom, name, cost, source, target,
				ST_Reverse(the_geom) AS flip_geom FROM &#39; ||
                        &#39;pgr_dijkstra(&#39;&#39;SELECT gid as id, source::int, target::int, &#39;
                                        || &#39;length::float AS cost FROM &#39;
                                        || quote_ident(tbl) || &#39;&#39;&#39;, &#39;
                                        || source || &#39;, &#39; || target
                                        || &#39; , false, false), &#39;
                                || quote_ident(tbl) || &#39; WHERE id2 = gid ORDER BY seq&#39;;

	-- Remember start point
        point := source;

        FOR rec IN EXECUTE sql
        LOOP
		-- Flip geometry (if required)
		IF ( point != rec.source ) THEN
			rec.the_geom := rec.flip_geom;
			point := rec.source;
		ELSE
			point := rec.target;
		END IF;

		-- Calculate heading (simplified)
		EXECUTE &#39;SELECT degrees( ST_Azimuth(
				ST_StartPoint(&#39;&#39;&#39; || rec.the_geom::text || &#39;&#39;&#39;),
				ST_EndPoint(&#39;&#39;&#39; || rec.the_geom::text || &#39;&#39;&#39;) ) )&#39;
			INTO heading;

		-- Return record
                seq     := seq + 1;
                gid     := rec.gid;
                name    := rec.name;
                cost    := rec.cost;
                geom    := rec.the_geom;
                RETURN NEXT;
        END LOOP;
        RETURN;
END;
$BODY$
LANGUAGE &#39;plpgsql&#39;;
</pre></div>
</div>
<p>What the function does not do:</p>
<ul class="simple">
<li>It does not restrict the selected road network by BBOX (necessary for large
networks)</li>
<li>It does not return road classes and several other attributes</li>
<li>It does not take into account one-way streets</li>
<li>There is no error handling</li>
</ul>
<p class="rubric">Example query</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pgr_fromAtoB</span><span class="p">(</span><span class="s1">&#39;ways&#39;</span><span class="p">,</span><span class="mi">7</span><span class="p">.</span><span class="mi">1192</span><span class="p">,</span><span class="mi">50</span><span class="p">.</span><span class="mi">7149</span><span class="p">,</span><span class="mi">7</span><span class="p">.</span><span class="mi">0979</span><span class="p">,</span><span class="mi">50</span><span class="p">.</span><span class="mi">7346</span><span class="p">);</span>
</pre></div>
</div>
<p>To store the query result as a table run</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">temp_route</span> <span class="k">AS</span>
        <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pgr_fromAtoB</span><span class="p">(</span><span class="s1">&#39;ways&#39;</span><span class="p">,</span><span class="mi">7</span><span class="p">.</span><span class="mi">1192</span><span class="p">,</span><span class="mi">50</span><span class="p">.</span><span class="mi">7149</span><span class="p">,</span><span class="mi">7</span><span class="p">.</span><span class="mi">0979</span><span class="p">,</span><span class="mi">50</span><span class="p">.</span><span class="mi">7346</span><span class="p">);</span>
<span class="c1">--DROP TABLE temp_route;</span>
</pre></div>
</div>
<p>Save the function code above into a file <tt class="docutils literal"><span class="pre">~/Desktop/workshop/fromAtoB.sql</span></tt>.
We can then install this function into the database with:</p>
<div class="highlight-bash"><div class="highlight"><pre>psql -U user -d city_routing -f ~/Desktop/workshop/fromAtoB.sql
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2010-2016 Daniel Kastl, Vicky Vergara.<br/>
      Last updated on Aug 21, 2016.<br/>
    </p>
  </div>
</footer>
  </body>
</html>