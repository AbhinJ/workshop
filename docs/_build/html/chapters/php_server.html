<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8. Server side scripts with PHP &mdash; Workshop - FOSS4G routing with pgRouting tools, OpenStreetMap road data and GeoExt</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Workshop - FOSS4G routing with pgRouting tools, OpenStreetMap road data and GeoExt" href="../index.html" />
    <link rel="next" title="9. GeoExt Browser Client" href="geoext_client.html" />
    <link rel="prev" title="7. Advanced usage of pgRouting shortest path search" href="advanced.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="geoext_client.html" title="9. GeoExt Browser Client"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="advanced.html" title="7. Advanced usage of pgRouting shortest path search"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Workshop - FOSS4G routing with pgRouting tools, OpenStreetMap road data and GeoExt</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="server-side-scripts-with-php">
<h1>8. Server side scripts with PHP<a class="headerlink" href="#server-side-scripts-with-php" title="Permalink to this headline">¶</a></h1>
<p>We will use a PHP script to make the routing query and send the result back to the web client.</p>
<p>The following steps are necessary:</p>
<p>Retrieve the start and end point coordinates.
Find the closest edge to start/end point.
Take either the start or end vertex of this edge (for Dijkstra/ A-Star) or the complete edge (Shooting-Star) as start of the route and end respectively.
Make the Shortest Path database query.
Transform the query result to XML and send it back to the web client.</p>
<div class="highlight-php"><pre>&lt;?php

  // Database connection settings
  define("PG_DB"  , "routing");
  define("PG_HOST", "localhost");
  define("PG_USER", "postgres");
  define("PG_PORT", "5432");
  define("TABLE",   "victoria");

  $counter = $pathlength = 0;

  // Retrieve start point
  $start = split(' ',$_REQUEST['startpoint']);
  $startPoint = array($start[0], $start[1]);

  // Retrieve end point
  $end = split(' ',$_REQUEST['finalpoint']);
  $endPoint = array($end[0], $end[1]);

  /* ... */


Select closest edge
-------------------------------------------------------------------------------------------------------------

Usually the start and end point, which we retrieved from the client, is not the start or end vertex of an edge. It is more convenient to look for the closest edge than for the closest vertex, because Shooting Star algorithm is “edge-based”. For “vertex-based” algorithms (Dijkstra, A-Star) we can choose arbitrary start or end of the selected edge.

  // Find the nearest edge
  $startEdge = findNearestEdge($startPoint);
  $endEdge   = findNearestEdge($endPoint);

  // FUNCTION findNearestEdge
  function findNearestEdge($lonlat) {

        // Connect to database
        $con = pg_connect("dbname=".PG_DB." host=".PG_HOST." user=".PG_USER);

        $sql = "SELECT gid, source, target, the_geom,
                         distance(the_geom, GeometryFromText(
                      'POINT(".$lonlat[0]." ".$lonlat[1].")', 54004)) AS dist
                FROM ".TABLE."
                WHERE the_geom &amp;&amp; setsrid(
                      'BOX3D(".($lonlat[0]-200)."
                             ".($lonlat[1]-200).",
                             ".($lonlat[0]+200)."
                             ".($lonlat[1]+200).")'::box3d, 54004)
                ORDER BY dist LIMIT 1";

        $query = pg_query($con,$sql);

        $edge['gid']      = pg_fetch_result($query, 0, 0);
        $edge['source']   = pg_fetch_result($query, 0, 1);
        $edge['target']   = pg_fetch_result($query, 0, 2);
        $edge['the_geom'] = pg_fetch_result($query, 0, 3);

        // Close database connection
        pg_close($con);

        return $edge;
  }


Routing Query
-------------------------------------------------------------------------------------------------------------

Previous: Select closest edge

  // Select the routing algorithm
  switch($_REQUEST['method']) {
For Shortest Path Dijkstra

        case 'SPD' : // Shortest Path Dijkstra

          $sql = "SELECT rt.gid, AsText(rt.the_geom) AS wkt,
                       length(rt.the_geom) AS length, ".TABLE.".id
                    FROM ".TABLE.",
                        (SELECT gid, the_geom
                            FROM dijkstra_sp_delta(
                                '".TABLE."',
                                ".$startEdge['source'].",
                                ".$endEdge['target'].",
                                3000)
                         ) as rt
                    WHERE ".TABLE.".gid=rt.gid;";
          break;
For Shortest Path A-Star

        case 'SPA' : // Shortest Path A*

          $sql = "SELECT rt.gid, AsText(rt.the_geom) AS wkt,
                         length(rt.the_geom) AS length, ".TABLE.".id
                      FROM ".TABLE.",
                          (SELECT gid, the_geom
                              FROM astar_sp_delta(
                                  '".TABLE."',
                                  ".$startEdge['source'].",
                                  ".$endEdge['target'].",
                                  3000)
                           ) as rt
                      WHERE ".TABLE.".gid=rt.gid;";
          break;
For Shortest Path Shooting-Star

        case 'SPS' : // Shortest Path Shooting*

          $sql = "SELECT rt.gid, AsText(rt.the_geom) AS wkt,
                         length(rt.the_geom) AS length, ".TABLE.".id
                      FROM ".TABLE.",
                          (SELECT gid, the_geom
                              FROM shootingstar_sp(
                                  '".TABLE."',
                                  ".$startEdge['gid'].",
                                  ".$endEdge['gid'].",
                                  5000, 'length', true, true)
                           ) as rt
                      WHERE ".TABLE.".gid=rt.gid;";
          break;
Query database

  } // close switch

  // Connect to database
  $dbcon = pg_connect("dbname=".PG_DB." host=".PG_HOST." user=".PG_USER);

  // Perform database query
  $query = pg_query($dbcon,$sql);


XML output (Or GeoJSON?)
-------------------------------------------------------------------------------------------------------------
OpenLayers allows to draw lines directly using WKT (Well-Known Text) format. This makes the XML output short and simple:

Previous: Routing query

  // Return route as XML
  $xml  = '&lt;?xml version="1.0" encoding="UTF-8" standalone="yes" ?&gt;'."\n";
  $xml .= "&lt;route&gt;\n";

  // Add edges to XML file
  while($edge=pg_fetch_assoc($query)) {

        $pathlength += $edge['length'];

        $xml .= "\t&lt;edge id='".++$counter."'&gt;\n";
        $xml .= "\t\t&lt;id&gt;".$edge['id']."&lt;/id&gt;\n";
        $xml .= "\t\t&lt;wkt&gt;".$edge['wkt']."&lt;/wkt&gt;\n";
        $xml .= "\t\t&lt;length&gt;".round(($pathlength/1000),3)."&lt;/length&gt;\n";
        $xml .= "\t&lt;/edge&gt;\n";
  }

  $xml .= "&lt;/route&gt;\n";

  // Close database connection
  pg_close($dbcon);

  // Return routing result
  header('Content-type: text/xml',true);
  echo $xml;
?&gt;


GeoJSON Template
-------------------------------------------------------------------------------------------------------------

{ "type": "FeatureCollection",
        "features": [
$edges:{ e |
                \{ "type": "Feature",
                        "geometry": \{
                                "type": "LineString",
                                "coordinates": [
                                        $e.points:{ p | [$p.x$, $p.y$] };separator=","$
                                ]
                        \},
                        "crs": \{
                                "type": "EPSG",
                                "properties": \{"code": "srid"\}
                        \},
                        "properties": \{
                                "id": "$e.id$"
                        \}
                \}
};separator=","$
        ],
        "status": {
                "code": 200,
                "request": "route"
        },
        "user": {
                "request_id": "$request_id$"
        }
}</pre>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/pgrouting-logo.gif" alt="Logo"/>
            </a></p>
            <h4>Previous topic</h4>
            <p class="topless"><a href="advanced.html"
                                  title="previous chapter">7. Advanced usage of pgRouting shortest path search</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="geoext_client.html"
                                  title="next chapter">9. GeoExt Browser Client</a></p>
    
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    <h3>License</h3>
    <p style="font-size: 90%; margin-top:2px;">This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-Share Alike 3.0 License</a>.</p>
    <p style="margin:0;"><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a></p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="geoext_client.html" title="9. GeoExt Browser Client"
             >next</a></li>
        <li class="right" >
          <a href="advanced.html" title="7. Advanced usage of pgRouting shortest path search"
             >previous</a> |</li>
        <li><a href="../index.html">Workshop - FOSS4G routing with pgRouting tools, OpenStreetMap road data and GeoExt</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, Daniel Kastl, Frédéric Junod.
      Last updated on Jul 05, 2010.
    </div>
  </body>
</html>