<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>10. OpenLayers 3 ベースのルート検索インターフェース &mdash; Workshop - FOSS4G routing with pgRouting</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Workshop - FOSS4G routing with pgRouting" href="../index.html" />
    <link rel="prev" title="9. GeoServer による WMS サーバ" href="geoserver.html" />
	<script type="text/javascript">
	/* <![CDATA[ */
	    (function() {
	        var s = document.createElement('script'), t = document.getElementsByTagName('script')[0];
	        s.type = 'text/javascript';
	        s.async = true;
	        s.src = 'http://api.flattr.com/js/0.6/load.js?mode=auto';
	        t.parentNode.insertBefore(s, t);
	    })();
	/* ]]> */</script>

	<style>
		.toctree-wrapper {
			-webkit-column-count: 2;
			-moz-column-count: 2;
			column-count: 2;
		}
	</style>

  </head>
  <body>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="geoserver.html" title="9. GeoServer による WMS サーバ"
             accesskey="P">前へ</a></li>
        <li><a href="../index.html">Workshop - FOSS4G routing with pgRouting</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="openlayers-3-based-routing-interface">
<span id="ol3"></span><h1>10. OpenLayers 3 ベースのルート検索インターフェース<a class="headerlink" href="#openlayers-3-based-routing-interface" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>この章の目的は、OpenLayers 3 により pgRouting への簡単なウェブベースのユーザインターフェースを作成することです。経路探索の出発地と目的地の場所を選択し、出発地点と目的地点からルートを取得することが可能となります。</p>
<p>出発地点と目的地点はユーザにより、地図上でクリックすることで作成されます。その後、出発地点と目的地点の座標は WMS サーバ (GeoServer) に WMS の <tt class="docutils literal"><span class="pre">GetMap</span></tt> リクエストとして送信されます。結果画像は地図に <em>画像</em> レイヤとして追加されます。</p>
<div class="section" id="openlayers-3-introduction">
<h2>10.1. OpenLayers 3 入門<a class="headerlink" href="#openlayers-3-introduction" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>OpenLayers 3 は OpenLayers 2 を完全に書き直したものです。 Canvas や WebGL などの最新の JavaScript と HTML5 技術を使用しています。</p>
<p>ウェブページ上で OpenLayers 3 地図を作成するには、 <tt class="docutils literal"><span class="pre">ol.Map</span></tt> クラスのインスタンスとなる <em>地図</em> オブジェクトを作成します。そうすることで、データレイヤやコントロールをその地図オブジェクトに追加することが可能となります。</p>
<p>地図の中心や解像度 (ズームレベル) は <em>ビュー</em> オブジェクトを介して制御します。他の地図ライブラリと異なり、ビューは地図から切り離されています; 優位性の一つとして、複数の地図で同一のビューを共有することが可能になることが上げられます。 <a class="reference external" href="http://openlayers.org/en/master/examples/preload.html">こちらのサンプル</a> を参照してください。</p>
<p>OpenLayers 3 は 3 つのレンダラーを持っています: <em>Canvas</em> レンダラー、 <em>WebGL</em> レンダラー、 <em>DOM</em> レンダラー。今のところ、最も機能の多いレンダラーは Canvas となります。とりわけ、 Canvas レンダラーは、他の 2 つがサポートしていない、ベクタレイヤをサポートしています。 Canvas がデフォルトのレンダラーで、このワークショップでも、このレンダラーを使用します。</p>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">将来的には、 WebGL レンダラーが大量のベクタデータや 3D オブジェクトを描画するために使用されるようになります。</p>
</div>
</div>
<div class="section" id="creating-a-minimal-map">
<h2>10.2. 最小限の地図の作成<a class="headerlink" href="#creating-a-minimal-map" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>では、最初の OpenLayers 3 地図を作成しましょう: テキストエディタを開き、以下のコードをコピーして <tt class="docutils literal"><span class="pre">ol3.html</span></tt> という名前のファイルを作成します。このファイルは、 <tt class="docutils literal"><span class="pre">Desktop</span></tt> に保存して、ウェブブラウザで開くことができます。</p>
<div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>ol3 pgRouting client<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;ol3/ol.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;style&gt;</span>
  <span class="nf">#map</span> <span class="p">{</span>
    <span class="k">width</span><span class="o">:</span> <span class="m">100</span><span class="o">%</span><span class="p">;</span>
    <span class="k">height</span><span class="o">:</span> <span class="m">400px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">&lt;/style&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;ol3/ol.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
  <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
    <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
    <span class="nx">layers</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Tile</span><span class="p">({</span>
        <span class="nx">source</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">OSM</span><span class="p">()</span>
      <span class="p">})</span>
    <span class="p">],</span>
    <span class="nx">view</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">View</span><span class="p">({</span>
      <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">13657275.569447909</span><span class="p">,</span> <span class="mf">5699392.057118396</span><span class="p">],</span>
      <span class="nx">zoom</span><span class="o">:</span> <span class="mi">10</span>
    <span class="p">}),</span>
    <span class="nx">controls</span><span class="o">:</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({</span>
      <span class="nx">attributionOptions</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">collapsible</span><span class="o">:</span> <span class="kc">false</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">});</span>
  <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>このウェブページは OpenStreetMap レイヤの簡単な地図を含み、既定の位置を中心としています。今のところ、ルート検索に関連したコードはありません; 単に標準のナビゲーションツールを備えた簡単な地図となります。</p>
<p>各行では以下を行っています:</p>
<blockquote>
<div><ul class="simple">
<li><p class="first">6 行目: デフォルトの OpenLayers CSS ファイルを読み込みます。</p>
</li>
<li><p class="first">7 〜 12 行目: 地図の DOM 要素にサイズを割り当てるため、 CSS ルールを記述します。</p>
</li>
<li><p class="first">15行目: 地図のために div 要素を追加します。要素の識別子は <tt class="docutils literal"><span class="pre">map</span></tt> とします。</p>
</li>
<li><p class="first">16行目: OpenLayers 3 のライブラリコードを読み込みます。 <tt class="docutils literal"><span class="pre">ol</span></tt> 名前空間に含まれる関数とクラスは、ここで使用可能となります。</p>
</li>
<li><p class="first">18 〜 29行目: このサンプル特有の JavaScript コードとなります。</p>
</li>
</ul>
</div></blockquote>
<p>では、 OpenLayers 3 の地図を作成する箇所について、さらに深く見ていきましょう:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
  <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span>
  <span class="nx">layers</span><span class="o">:</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Tile</span><span class="p">({</span>
      <span class="nx">source</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">OSM</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">],</span>
  <span class="nx">view</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">View</span><span class="p">({</span>
    <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">13657275.569447909</span><span class="p">,</span> <span class="mf">5699392.057118396</span><span class="p">],</span>
    <span class="nx">zoom</span><span class="o">:</span> <span class="mi">10</span>
  <span class="p">}),</span>
  <span class="nx">controls</span><span class="o">:</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({</span>
    <span class="nx">attributionOptions</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">collapsible</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span>
</pre></div>
</div>
<p>このコードは <tt class="docutils literal"><span class="pre">target</span></tt> が HTML ページ内の <tt class="docutils literal"><span class="pre">map</span></tt> DOM 要素となる <tt class="docutils literal"><span class="pre">ol.Map</span></tt> インスタンスを作成します。地図は <em>タイルレイヤ</em> の設定を含み、レイヤは OpenStreetMap の <em>source</em> 設定を含みます。地図はさらに、既定の <em>center</em> と <em>zoom</em> レベルの既定値を定義した <em>view</em> インスタンス (<tt class="docutils literal"><span class="pre">ol.View</span></tt> クラス) の設定を含みます。</p>
<p>コード内の center と zoom レベルを変更し、ブラウザでページを再読み込みすることで、その効果を確認することができます。さらに、ブラウザの JavaScript コンソールで動的にビューを変更するすることも可能です。例:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">map</span><span class="p">.</span><span class="nx">getView</span><span class="p">().</span><span class="nx">getCenter</span><span class="p">();</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">getView</span><span class="p">().</span><span class="nx">setCenter</span><span class="p">([</span><span class="o">-</span><span class="mi">29686</span><span class="p">,</span> <span class="mi">6700403</span><span class="p">]);</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">getView</span><span class="p">().</span><span class="nx">setRotation</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="wms-get-parameters">
<h2>10.3. WMS GET パラメータ<a class="headerlink" href="#wms-get-parameters" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>以下のコードを地図の作成の後に追加します。</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">LAYERS</span><span class="o">:</span> <span class="s1">&#39;pgrouting:pgrouting&#39;</span><span class="p">,</span>
  <span class="nx">FORMAT</span><span class="o">:</span> <span class="s1">&#39;image/png&#39;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">params</span></tt> オブジェクトは GeoServer に送信される WMS GET パラメータを保持します。ここでは、変更されることのない値: レイヤ名称と出力フォーマット を設定します。</p>
</div>
<div class="section" id="select-start-and-destination">
<h2>10.4. &#8220;出発地&#8221; と &#8220;目的地&#8221; の選択<a class="headerlink" href="#select-start-and-destination" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>地図上でのクリックにより、ユーザが出発地と目的地を追加できるようにすることが必要です。以下のコードを追加します:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// The &quot;start&quot; and &quot;destination&quot; features.</span>
<span class="kd">var</span> <span class="nx">startPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">Feature</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">destPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">Feature</span><span class="p">();</span>

<span class="c1">// The vector layer used to display the &quot;start&quot; and &quot;destination&quot; features.</span>
<span class="kd">var</span> <span class="nx">vectorLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">({</span>
  <span class="nx">source</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">Vector</span><span class="p">({</span>
    <span class="nx">features</span><span class="o">:</span> <span class="p">[</span><span class="nx">startPoint</span><span class="p">,</span> <span class="nx">destPoint</span><span class="p">]</span>
  <span class="p">})</span>
<span class="p">});</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">vectorLayer</span><span class="p">);</span>
</pre></div>
</div>
<p>上記コードは 2 つのベクタフィーチャを作成し、 1 つは &#8220;出発地&#8221; 、もう 1 つは &#8220;目的地&#8221; となります。 これらのフィーチャは、今のところ空 - ジオメトリを含まない - 状態となります。</p>
<p>上記コードは、さらにベクタレイヤを作成し、 &#8220;出発地&#8221; と &#8220;目的地&#8221; のフィーチャを追加しています。さらに、 map の <tt class="docutils literal"><span class="pre">addLayer</span></tt> メソッドにより、地図にベクタレイヤを追加しています。</p>
<p>次に、以下のコードを追加します:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="c1">// A transform function to convert coordinates from EPSG:3857</span>
<span class="c1">// to EPSG:4326.</span>
<span class="kd">var</span> <span class="nx">transform</span> <span class="o">=</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">proj</span><span class="p">.</span><span class="nx">getTransform</span><span class="p">(</span><span class="s1">&#39;EPSG:3857&#39;</span><span class="p">,</span> <span class="s1">&#39;EPSG:4326&#39;</span><span class="p">);</span>

<span class="c1">// Register a map click listener.</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">startPoint</span><span class="p">.</span><span class="nx">getGeometry</span><span class="p">()</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// First click.</span>
    <span class="nx">startPoint</span><span class="p">.</span><span class="nx">setGeometry</span><span class="p">(</span><span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">coordinate</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">destPoint</span><span class="p">.</span><span class="nx">getGeometry</span><span class="p">()</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Second click.</span>
    <span class="nx">destPoint</span><span class="p">.</span><span class="nx">setGeometry</span><span class="p">(</span><span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">coordinate</span><span class="p">));</span>
    <span class="c1">// Transform the coordinates from the map projection (EPSG:3857)</span>
    <span class="c1">// to the server projection (EPSG:4326).</span>
    <span class="kd">var</span> <span class="nx">startCoord</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">startPoint</span><span class="p">.</span><span class="nx">getGeometry</span><span class="p">().</span><span class="nx">getCoordinates</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">destCoord</span> <span class="o">=</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">destPoint</span><span class="p">.</span><span class="nx">getGeometry</span><span class="p">().</span><span class="nx">getCoordinates</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">viewparams</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">&#39;x1:&#39;</span> <span class="o">+</span> <span class="nx">startCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;y1:&#39;</span> <span class="o">+</span> <span class="nx">startCoord</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="s1">&#39;x2:&#39;</span> <span class="o">+</span> <span class="nx">destCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;y2:&#39;</span> <span class="o">+</span> <span class="nx">destCoord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">];</span>
    <span class="nx">params</span><span class="p">.</span><span class="nx">viewparams</span> <span class="o">=</span> <span class="nx">viewparams</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Image</span><span class="p">({</span>
      <span class="nx">source</span><span class="o">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">ImageWMS</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://localhost:8082/geoserver/pgrouting/wms&#39;</span><span class="p">,</span>
        <span class="nx">params</span><span class="o">:</span> <span class="nx">params</span>
      <span class="p">})</span>
    <span class="p">});</span>
    <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>上記のコードは、地図の <tt class="docutils literal"><span class="pre">click</span></tt> イベントのためのリスナー関数を登録します。このことは、 OpenLayers 3 は地図上でのクリックイベントの検知の度に、この関数を呼び出すことを意味しています。</p>
<p>リスナー関数に渡されるイベントオブジェクトは、 クリックの地理的な位置を表す <tt class="docutils literal"><span class="pre">coordinate</span></tt> プロパティを含みます。 coordinate は &#8220;出発地&#8221; と &#8220;目的地&#8221; フィーチャの <em>ポイント</em> ジオメトリを作成するのに使用されます。</p>
<p>一度、始点と目的地のポイントが(2度のクリックにより)確定すると、2つの座標値のペアは、地図の投影法(<tt class="docutils literal"><span class="pre">EPSG:3857</span></tt>)からサーバの投影法(<tt class="docutils literal"><span class="pre">EPSG:4326</span></tt>)に <tt class="docutils literal"><span class="pre">transform</span></tt> 関数を使用して変換されます。</p>
<p><tt class="docutils literal"><span class="pre">viewparams</span></tt> プロパティは WMS GET パラメータオブジェクトに設定されます。このプロパティの値は特別な意味を持ちます: GeoServer はこのレイヤのための SQL クエリを実行する前に、この値を代用します。例えば、もし:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">ways</span> <span class="k">WHERE</span> <span class="n">maxspeed_forward</span> <span class="k">BETWEEN</span> <span class="o">%</span><span class="k">min</span><span class="o">%</span> <span class="k">AND</span> <span class="o">%</span><span class="k">max</span><span class="o">%</span>
</pre></div>
</div>
<p>の場合、 <tt class="docutils literal"><span class="pre">viewparams</span></tt> は <tt class="docutils literal"><span class="pre">viewparams=min:20;max:120</span></tt> となり、 PostGIS に送信される SQL クエリは:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">ways</span> <span class="k">WHERE</span> <span class="n">maxspeed_forward</span> <span class="k">BETWEEN</span> <span class="mi">20</span> <span class="k">AND</span> <span class="mi">120</span>
</pre></div>
</div>
<p>となります。最後に、param オブジェクトが渡された、新しい OpenLayers WMS レイヤが作成されて、地図に追加されます。</p>
</div>
<div class="section" id="clear-the-results">
<h2>10.5. 結果のクリア<a class="headerlink" href="#clear-the-results" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>以下のコードを HTML ページの地図の <tt class="docutils literal"><span class="pre">div</span></tt> の後に追加します:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;clear&quot;</span><span class="nt">&gt;</span>clear<span class="nt">&lt;/button&gt;</span>
</pre></div>
</div>
<p>上記により、ルート検索ポイントをクリアし、新しいルート検索クエリを開始することを可能にするボタンが作成されます。</p>
<p>次に、以下のコードを JavaScript コードに追加します:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">clearButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;clear&#39;</span><span class="p">);</span>
<span class="nx">clearButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Reset the &quot;start&quot; and &quot;destination&quot; features.</span>
  <span class="nx">startPoint</span><span class="p">.</span><span class="nx">setGeometry</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="nx">destPoint</span><span class="p">.</span><span class="nx">setGeometry</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="c1">// Remove the result layer.</span>
  <span class="nx">map</span><span class="p">.</span><span class="nx">removeLayer</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p>このボタンがクリックされた際は、 <tt class="docutils literal"><span class="pre">addEventListener</span></tt> に渡されたこの関数が実行されます。この関数は &#8220;出発地&#8221; と &#8220;目的地&#8221; のフィーチャをリセットし、ルート検索結果レイヤを地図から削除します。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/pgrouting.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">10. OpenLayers 3 ベースのルート検索インターフェース</a><ul>
<li><a class="reference internal" href="#openlayers-3-introduction">10.1. OpenLayers 3 入門</a></li>
<li><a class="reference internal" href="#creating-a-minimal-map">10.2. 最小限の地図の作成</a></li>
<li><a class="reference internal" href="#wms-get-parameters">10.3. WMS GET パラメータ</a></li>
<li><a class="reference internal" href="#select-start-and-destination">10.4. &#8220;出発地&#8221; と &#8220;目的地&#8221; の選択</a></li>
<li><a class="reference internal" href="#clear-the-results">10.5. 結果のクリア</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="geoserver.html"
                        title="前の章へ">9. GeoServer による WMS サーバ</a></p>
	
<div id="searchbox" style="display: none">
  <h3>クイック検索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    モジュール、クラス、または関数名を入力してください
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
	<h3>License</h3>
	<p style="font-size: 90%; margin-top:2px;">This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-Share Alike 3.0 License</a>.</p>
	<p style="margin:0 0 10px 0;"><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png"></a></p>

	<!-- <p>
		<a class="FlattrButton" style="display:none;" rev="flattr;button:compact;" href="http://workshop.pgrouting.org"></a>
		<noscript><a href="http://flattr.com/thing/977418/pgRouting-Workshop" target="_blank">
		<img src="http://api.flattr.com/button/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0" /></a></noscript>
	</p> -->

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="geoserver.html" title="9. GeoServer による WMS サーバ"
             >前へ</a></li>
        <li><a href="../index.html">Workshop - FOSS4G routing with pgRouting</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010-2014 Daniel Kastl, Frédéric Junod.
      最終更新: Nov 12, 2014
    </div>
  </body>
</html>