<!DOCTYPE html>
<html>
  <head>
    <title>ol3 pgRouting client</title>
    <meta charset="utf-8">
    <link href="ol3/ol.css" rel="stylesheet">
    <style>
      #ol-map {
        width: 100%;
        height: 400px;
      }
    </style>
    <script src="ol3/ol.js"></script>
  </head>
  <body>
    <div id="ol-map"></div>

    <select id="algorithm">
      <option value="SPD" selected>Shortest Path Dijkstra</option>
      <option value="SPA">Shortest Path A*</option>
      <option value="SPS">Shortest Path Shooting*</option>
    </select>

    <button id="clear">clear</button>
    <script type="text/javascript">

      var map = new ol.Map({
        target: 'ol-map',
        layers: [
          new ol.layer.TileLayer({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View2D({
          center: [0, 0],
          zoom: 2
        })
      });

      var params = {
        FORMAT: 'image/png',
        METHOD: 'SPD'
      };

      map.addLayer(new ol.layer.ImageLayer({
        visible: false,
        source: new ol.source.SingleImageWMS({
          url: 'http://localhost',
          params: params
        })
      }));

      document.getElementById('algorithm').addEventListener('change', function(event) {
        params.METHOD = event.target.value;
        // FIXME: refresh layer
      });

      var transform = ol.proj.getTransformFromProjections('EPSG:3857', 'EPSG:4326');

      map.on('click', function(event) {
        var coordinate = event.getCoordinate();
        if (!params.STARTPOINT) {
          // first click
          var div = document.createElement('div');
          div.innerText = 'start';
          new ol.Overlay({
            map: map,
            element: div,
            position: coordinate
          });
          params.STARTPOINT = transform(coordinate).join(' ');
        } else if (!params.FINALPOINT) {
          // second click
          var div = document.createElement('div');
          div.innerText = 'stop';
          new ol.Overlay({
            map: map,
            element: div,
            position: coordinate
          });
          params.FINALPOINT = transform(coordinate).join(' ');

          // we now have the two points
          // FIXME: refresh layer
        }
      });

      document.getElementById('clear').addEventListener('click', function(event) {
        delete params.STARTPOINT;
        delete params.FINALPOINT;
        // FIXME: remove overlays
        // FIXME: hide layer
      });

    </script>
  </body>
</html>
