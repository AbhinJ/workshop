<html>
<head>

<title>A Basic GeoExt Page</title>
<script src="Ext-3.2.1/adapter/ext/ext-base.js" type="text/javascript"></script>
<script src="Ext-3.2.1/ext-all.js"  type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="Ext-3.2.1/resources/css/ext-all.css" />
<script src="OpenLayers-2.9.1/lib/OpenLayers.js" type="text/javascript"></script>
<script src="GeoExt-0.7/lib/GeoExt.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="GeoExt-0.7/resources/css/geoext-all-debug.css" />

<script src="DrawPoints.js" type="text/javascript"></script>

<script type="text/javascript">

     function pgrouting(store, layer, combo) {
         if (layer.features.length == 2) {
             // erase the previous route
             store.removeAll();

             var startpoint = layer.features[0].geometry;
             var finalpoint = layer.features[1].geometry;
             store.load({
                 params: {
                     startpoint: startpoint.x + ' ' + startpoint.y,
                     finalpoint: finalpoint.x + ' ' + finalpoint.y,
                     method: combo.getValue()
                 }
             });
        }
    }

    Ext.onReady(function() {
        var panel = new GeoExt.MapPanel({
            renderTo: 'gxmap',
            map: {
                layers: [new OpenLayers.Layer.OSM("Simple OSM Map")]
            },
            center: [245300, 5070600],
            zoom: 11,
            height: 400,
            width: 600,
            title: 'A Simple GeoExt Map'
        });
        var map = panel.map;
        
        // create the layer where we will draw the route
        var route_layer = new OpenLayers.Layer.Vector();
        map.addLayers([route_layer]);

        // create the store to query the web service
        var store = new GeoExt.data.FeatureStore({
            layer: route_layer,
            fields: [
                {name: 'length'}
            ],
            proxy: new Ext.data.HttpProxy({
                url: 'foo',
                method: 'GET'
            })
        });

        var method = new Ext.form.ComboBox({
            renderTo: "method",
            triggerAction: 'all',
            editable: false,
            forceSelection: true,
            store: [
                ['SPD', 'Shortest Path Dijkstra'],
                ['SPA', 'Shortest Path A*'],
                ['SPS', 'Shortest Path Shooting*']
            ],
            listeners: {
                select: function() {
                    pgrouting(store, draw_layer, method);
                }
            }
        });
        // default method is Shortest Path Dijkstra
        method.setValue('SPD');

        var map = panel.map;

        var draw_layer = new OpenLayers.Layer.Vector();
        map.addLayers([draw_layer]);

        var draw_points = new DrawPoints(draw_layer);
        var drag_points = new OpenLayers.Control.DragFeature(draw_layer, {
                autoActivate: true
        });
        draw_layer.events.on({
          featureadded: function() {
              pgrouting(store, draw_layer, method);
          }
        });

        drag_points.onComplete = function() {
              pgrouting(store, draw_layer, method);
        };

        map.addControls([draw_points, drag_points]);

//         var draw_points = new OpenLayers.Control.DrawFeature(draw_layer, OpenLayers.Handler.Point);
//         map.addControl(draw_points);
//         draw_points.activate();


//         var form = new Ext.form.FormPanel({
//             renderTo: 'form',
//             width: 400,
//             defaultType: 'textfield',
//             defaults: {width: 230},
//             items: [{
//                 fieldLabel: "departure",
//                 name: "startpoint",
//                 id: "startpoint"
//             }, {
//                 fieldLabel: "arrival",
//                 name: "finalpoint",
//                 id: "finalpoint"
//             }]
//         });
    });
</script>
</head>
<body>
<div id="gxmap"></div>
<div id="method"></div>
</body>
</html>
